@page "/evento/encerrar"
@inject EventoService EventoService
@inject ISnackbar Snackbar

<PageTitle>Encerrar MDFe</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Class="mb-4">🛑 Encerrar MDFe</MudText>
    
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Dados para Encerramento</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="8">
                    <MudTextField @bind-Value="chaveAcesso" 
                                 Label="Chave de Acesso do MDFe" 
                                 Variant="Variant.Outlined" 
                                 MaxLength="44"
                                 Counter="44"
                                 Required="true"
                                 HelperText="Chave de acesso de 44 dígitos do MDFe a ser encerrado" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="protocolo" 
                                 Label="Protocolo de Autorização" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="Protocolo de autorização do MDFe" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="ufEncerramento" 
                                 Label="UF de Encerramento" 
                                 Variant="Variant.Outlined" 
                                 MaxLength="2"
                                 Required="true"
                                 HelperText="UF onde o transporte foi encerrado" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="municipioEncerramento" 
                                 Label="Município de Encerramento" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="Município onde o transporte foi encerrado" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="justificativa" 
                                 Label="Justificativa" 
                                 Variant="Variant.Outlined" 
                                 Lines="3"
                                 MaxLength="255"
                                 Counter="255"
                                 Required="true"
                                 HelperText="Justificativa para o encerramento do MDFe" />
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="ExecutarEncerramento" 
                      Disabled="@(loading || !FormularioValido())"
                      StartIcon="Icons.Material.Filled.Stop">
                @if (loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span class="ml-2">Encerrando...</span>
                }
                else
                {
                    <span>Encerrar MDFe</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Text" 
                      Color="Color.Secondary" 
                      OnClick="LimparFormulario"
                      StartIcon="Icons.Material.Filled.Clear">
                Limpar
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (!string.IsNullOrEmpty(resultado))
    {
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">📋 Resultado do Encerramento</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudAlert Severity="@alertSeverity" Class="mb-3">
                    @alertMessage
                </MudAlert>
                <MudCode>@resultado</MudCode>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private string chaveAcesso = "";
    private string protocolo = "";
    private string ufEncerramento = "";
    private string municipioEncerramento = "";
    private string justificativa = "";
    private string resultado = "";
    private string alertMessage = "";
    private Severity alertSeverity = Severity.Info;
    private bool loading = false;

    private bool FormularioValido()
    {
        return !string.IsNullOrWhiteSpace(chaveAcesso) && chaveAcesso.Length == 44 &&
               !string.IsNullOrWhiteSpace(protocolo) &&
               !string.IsNullOrWhiteSpace(ufEncerramento) && ufEncerramento.Length == 2 &&
               !string.IsNullOrWhiteSpace(municipioEncerramento) &&
               !string.IsNullOrWhiteSpace(justificativa);
    }

    private async Task ExecutarEncerramento()
    {
        try
        {
            loading = true;
            
            var eventoData = new
            {
                ChaveAcesso = chaveAcesso,
                Protocolo = protocolo,
                UFEncerramento = ufEncerramento,
                MunicipioEncerramento = municipioEncerramento,
                Justificativa = justificativa,
                DataHoraEvento = DateTime.Now
            };

            resultado = await EventoService.EncerrarMDFeAsync(eventoData);
            
            alertMessage = "✅ Evento de encerramento registrado com sucesso!";
            alertSeverity = Severity.Success;
            Snackbar.Add("MDFe encerrado com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            alertMessage = $"❌ Erro ao encerrar MDFe: {ex.Message}";
            alertSeverity = Severity.Error;
            resultado = $"Erro: {ex.Message}";
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void LimparFormulario()
    {
        chaveAcesso = "";
        protocolo = "";
        ufEncerramento = "";
        municipioEncerramento = "";
        justificativa = "";
        resultado = "";
        alertMessage = "";
    }
}