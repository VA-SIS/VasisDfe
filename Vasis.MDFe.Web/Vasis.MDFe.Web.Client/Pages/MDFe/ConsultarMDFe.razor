@page "/mdfe/consultar"
@inject MDFeService MDFeService
@inject ISnackbar Snackbar

<PageTitle>Consultar MDFe</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Class="mb-4">🔍 Consultar MDFe</MudText>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Dados para Consulta</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="8">
                    <MudTextField @bind-Value="chaveAcesso"
                                  Label="Chave de Acesso"
                                  Variant="Variant.Outlined"
                                  MaxLength="44"
                                  Counter="44"
                                  HelperText="Chave de acesso de 44 dígitos do MDFe" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudSelect @bind-Value="ambiente"
                               Label="Ambiente"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">Produção</MudSelectItem>
                        <MudSelectItem Value="2">Homologação</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="ExecutarConsulta"
                       Disabled="@(loading || string.IsNullOrWhiteSpace(chaveAcesso) || chaveAcesso.Length != 44)"
                       StartIcon="Icons.Material.Filled.Search">
                @if (loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span class="ml-2">Consultando...</span>
                }
                else
                {
                    <span>Consultar MDFe</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Text"
                       Color="Color.Secondary"
                       OnClick="LimparConsulta"
                       StartIcon="Icons.Material.Filled.Clear">
                Limpar
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (!string.IsNullOrEmpty(resultado))
    {
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">📊 Resultado da Consulta</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudAlert Severity="@alertSeverity" Class="mb-3">
                    @alertMessage
                </MudAlert>

                @if (dadosConsulta != null)
                {
                    <MudSimpleTable Style="overflow-x: auto;" Class="mb-4">
                        <thead>
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Status</strong></td>
                                <td>@dadosConsulta.Status</td>
                            </tr>
                            <tr>
                                <td><strong>Número</strong></td>
                                <td>@dadosConsulta.Numero</td>
                            </tr>
                            <tr>
                                <td><strong>Série</strong></td>
                                <td>@dadosConsulta.Serie</td>
                            </tr>
                            <tr>
                                <td><strong>Data Emissão</strong></td>
                                <td>@dadosConsulta.DataEmissao</td>
                            </tr>
                            <tr>
                                <td><strong>Protocolo</strong></td>
                                <td>@dadosConsulta.Protocolo</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                }

                <MudTextField Value="@resultado"
                              Label="Resposta Completa"
                              Variant="Variant.Outlined"
                              Lines="8"
                              ReadOnly="true" />
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private string chaveAcesso = "";
    private string resultado = "";
    private string alertMessage = "";
    private Severity alertSeverity = Severity.Info;
    private int ambiente = 2;
    private bool loading = false;
    private DadosConsulta? dadosConsulta;

    public class DadosConsulta
    {
        public string Status { get; set; } = "";
        public string Numero { get; set; } = "";
        public string Serie { get; set; } = "";
        public string DataEmissao { get; set; } = "";
        public string Protocolo { get; set; } = "";
    }

    private async Task ExecutarConsulta()
    {
        try
        {
            loading = true;
            resultado = await MDFeService.ConsultarMDFeAsync(chaveAcesso);

            // Simular dados da consulta
            dadosConsulta = new DadosConsulta
            {
                Status = "Autorizado",
                Numero = "123456",
                Serie = "1",
                DataEmissao = DateTime.Now.AddDays(-1).ToString("dd/MM/yyyy"),
                Protocolo = "351240001234567"
            };

            alertMessage = "✅ Consulta realizada com sucesso!";
            alertSeverity = Severity.Success;
            Snackbar.Add("MDFe encontrado!", Severity.Success);
        }
        catch (Exception ex)
        {
            alertMessage = $"❌ Erro durante a consulta: {ex.Message}";
            alertSeverity = Severity.Error;
            resultado = $"Erro: {ex.Message}";
            dadosConsulta = null;
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void LimparConsulta()
    {
        chaveAcesso = "";
        resultado = "";
        alertMessage = "";
        dadosConsulta = null;
    }
}