@page "/mdfe/criar"
@inject MDFeService MDFeService
@inject ISnackbar Snackbar

<PageTitle>Criar MDFe</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Class="mb-4">🆕 Criar MDFe</MudText>
    
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Dados do Manifesto</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="numeroMDFe" 
                                 Label="Número MDFe" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="Número sequencial do manifesto" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="serie" 
                                 Label="Série" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="Série do manifesto" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Value="@modelo" 
                                 Label="Modelo" 
                                 Variant="Variant.Outlined" 
                                 Disabled="true"
                                 HelperText="Modelo fixo 58 para MDFe" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="tipoEmissao" 
                              Label="Tipo de Emissão" 
                              Variant="Variant.Outlined"
                              Required="true">
                        <MudSelectItem Value="1">Normal</MudSelectItem>
                        <MudSelectItem Value="2">Contingência</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="tipoTransportador" 
                              Label="Tipo Transportador" 
                              Variant="Variant.Outlined"
                              Required="true">
                        <MudSelectItem Value="1">ETC</MudSelectItem>
                        <MudSelectItem Value="2">TAC</MudSelectItem>
                        <MudSelectItem Value="3">CTC</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="ufInicio" 
                                 Label="UF Início" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 MaxLength="2"
                                 HelperText="UF de início do percurso" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="ufFim" 
                                 Label="UF Fim" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 MaxLength="2"
                                 HelperText="UF de fim do percurso" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="municipioInicio" 
                                 Label="Município Início" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="Município de início do percurso" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="municipioFim" 
                                 Label="Município Fim" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="Município de fim do percurso" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="observacoes" 
                                 Label="Observações" 
                                 Variant="Variant.Outlined" 
                                 Lines="3"
                                 HelperText="Observações adicionais (opcional)" />
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="ExecutarCriarMDFe" 
                      Disabled="@loading"
                      StartIcon="Icons.Material.Filled.Add">
                @if (loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span class="ml-2">Criando...</span>
                }
                else
                {
                    <span>Criar MDFe</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Text" 
                      Color="Color.Secondary" 
                      OnClick="LimparFormulario"
                      StartIcon="Icons.Material.Filled.Clear">
                Limpar
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (!string.IsNullOrEmpty(resultado))
    {
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">📋 Resultado</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudCode>@resultado</MudCode>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private string numeroMDFe = "";
    private string serie = "1";
    private string modelo = "58";
    private int tipoEmissao = 1;
    private int tipoTransportador = 1;
    private string ufInicio = "";
    private string ufFim = "";
    private string municipioInicio = "";
    private string municipioFim = "";
    private string observacoes = "";
    private string resultado = "";
    private bool loading = false;

    private async Task ExecutarCriarMDFe()
    {
        try
        {
            loading = true;
            
            var mdfeData = new
            {
                Numero = numeroMDFe,
                Serie = serie,
                Modelo = modelo,
                TipoEmissao = tipoEmissao,
                TipoTransportador = tipoTransportador,
                UFInicio = ufInicio,
                UFFim = ufFim,
                MunicipioInicio = municipioInicio,
                MunicipioFim = municipioFim,
                Observacoes = observacoes
            };

            resultado = await MDFeService.CriarMDFeAsync(mdfeData);
            Snackbar.Add("MDFe criado com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            resultado = $"Erro: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void LimparFormulario()
    {
        numeroMDFe = "";
        serie = "1";
        tipoEmissao = 1;
        tipoTransportador = 1;
        ufInicio = "";
        ufFim = "";
        municipioInicio = "";
        municipioFim = "";
        observacoes = "";
        resultado = "";
    }
}