@page "/mdfe/transmitir"
@inject MDFeService MDFeService
@inject ISnackbar Snackbar

<PageTitle>Transmitir MDFe</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Class="mb-4">📡 Transmitir MDFe</MudText>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">XML Assinado para Transmissão</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudTextField @bind-Value="xmlMDFe"
                          Label="XML do MDFe Assinado"
                          Variant="Variant.Outlined"
                          Lines="15"
                          FullWidth="true"
                          Placeholder="Cole aqui o XML do MDFe assinado para transmissão..."
                          HelperText="XML deve estar assinado digitalmente antes da transmissão" />

            <MudGrid Class="mt-4">
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="ambiente"
                               Label="Ambiente"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">Produção</MudSelectItem>
                        <MudSelectItem Value="2">Homologação</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSwitch T="bool" @bind-Checked="transmissaoSincrona"
                               Label="Transmissão Síncrona"
                               Color="Color.Primary" />
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="ExecutarTransmitirMDFe"
                       Disabled="@(loading || string.IsNullOrWhiteSpace(xmlMDFe))"
                       StartIcon="Icons.Material.Filled.Send">
                @if (loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span class="ml-2">Transmitindo...</span>
                }
                else
                {
                    <span>Transmitir MDFe</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Text"
                       Color="Color.Secondary"
                       OnClick="LimparFormulario"
                       StartIcon="Icons.Material.Filled.Clear">
                Limpar
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (!string.IsNullOrEmpty(resultado))
    {
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">�� Resultado da Transmissão</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudAlert Severity="@alertSeverity" Class="mb-3">
                    @alertMessage
                </MudAlert>

                @if (!string.IsNullOrEmpty(numeroProtocolo))
                {
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudTextField Value="@numeroProtocolo"
                                          Label="Número do Protocolo"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField Value="@dataHoraRecebimento"
                                          Label="Data/Hora Recebimento"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true" />
                        </MudItem>
                    </MudGrid>
                }

                <MudTextField Value="@resultado"
                              Label="Resposta Completa"
                              Variant="Variant.Outlined"
                              Lines="8"
                              ReadOnly="true"
                              Class="mt-3" />
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private string xmlMDFe = "";
    private string resultado = "";
    private string alertMessage = "";
    private string numeroProtocolo = "";
    private string dataHoraRecebimento = "";
    private Severity alertSeverity = Severity.Info;
    private int ambiente = 2;
    private bool transmissaoSincrona = true;
    private bool loading = false;

    private async Task ExecutarTransmitirMDFe()
    {
        try
        {
            loading = true;
            resultado = await MDFeService.TransmitirMDFeAsync(xmlMDFe);

            if (resultado.Contains("autorizado", StringComparison.OrdinalIgnoreCase))
            {
                numeroProtocolo = "351240001234567";
                dataHoraRecebimento = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
                alertMessage = "✅ MDFe transmitido e autorizado com sucesso!";
                alertSeverity = Severity.Success;
                Snackbar.Add("MDFe autorizado pela SEFAZ!", Severity.Success);
            }
            else if (resultado.Contains("rejeitado", StringComparison.OrdinalIgnoreCase))
            {
                alertMessage = "❌ MDFe rejeitado pela SEFAZ. Verifique os erros.";
                alertSeverity = Severity.Error;
                Snackbar.Add("MDFe rejeitado!", Severity.Error);
            }
            else
            {
                alertMessage = "ℹ️ Transmissão realizada. Verifique o status abaixo.";
                alertSeverity = Severity.Info;
                Snackbar.Add("Transmissão concluída!", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            alertMessage = $"❌ Erro durante a transmissão: {ex.Message}";
            alertSeverity = Severity.Error;
            resultado = $"Erro: {ex.Message}";
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void LimparFormulario()
    {
        xmlMDFe = "";
        resultado = "";
        alertMessage = "";
        numeroProtocolo = "";
        dataHoraRecebimento = "";
    }
}